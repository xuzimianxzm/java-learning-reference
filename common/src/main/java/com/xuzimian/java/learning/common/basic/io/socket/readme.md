## socks5 代理协议

### 选择认证方法
socks连接过程，首先客户端发送一个数据包到socks代理

| Var | NMETHODS | METHODS |
| --- | -------- | ------- |
| 1   | 1        | 0-255   |


> 表格里面的单位表示位数

Var 表示是SOCK版本，应该是５;
NMETHODS 表示 METHODS部分的长度
METHODS 表示支持客户端支持的认证方式列表，每个方法占1字节。当前的定义是

* 0x00 不需要认证  
* 0x01 GSSAPI  
* 0x02 用户名、密码认证  
* 0x03 - 0x7F由IANA分配（保留）  
* 0x80 - 0xFE为私人方法保留  
* 0xFF 无可接受的方法  


> 服务器会响应给客户端

| VER | METHOD |
| --- | ------ |
| 1   | 1      |

* Var 表示是SOCK版本，应该是５;
* METHOD 是服务端选中方法，这个的值为上面METHODS 列表中一个。如果客户端支持0x00，0x01，0x02，这三个方法。服务器只会选中一个认证方法返回给客户端，如果返回0xFF表示没有一个认证方法被选中，客户端需要关闭连接。
我们先用一个简单Nodejs在实现sock连接握手.查看客户端发送数据报

### 使用账号密码认证
当服务器选择0x02 账号密码方式认证后，客户端开始发送账号 、密码，数据包格式如下: (以字节为单位)
| VER | ULEN | UNAME    | PLEN | PASSWD   |
| --- | ---- | -------- | ---- | -------- |
| 1   | 1    | 1 to 255 | 1    | 1 to 255 |

* VER是SOCKS版本
* ULEN 用户名长度
* UNAME 账号string
* PLEN 密码长度
* PASSWD 密码string
  
> 账号密码都是明文传输，非常地不安全。 服务器端校验完成后，会响应以下数据():

| VER | STATUS |
| --- | ------ |
| 1   | 1      |

TATUS 0x00 表示成功，0x01 表示失败

### 封装请求

认证结束后客户端就可以发送请求信息。客户端开始封装请求信息
SOCKS5请求格式（以字节为单位）：



| VER | CMD | RSV  | ATYP | DST.ADDR | DST.PORT |
| --- | --- | ---- | ---- | -------- | -------- |
| 1   | 1   | 0x00 | 1    | 动态     | 2        |

* VER是SOCKS版本，这里应该是0x05；
* CMD是SOCK的命令码
  * 0x01表示CONNECT请求
  > CONNECT请求可以开启一个客户端与所请求资源之间的双向沟通的通道。它可以用来创建隧道（tunnel）。例如，**CONNECT **可以用来访问采用了 SSL (HTTPS)  协议的站点。客户端要求代理服务器将 TCP 连接作为通往目的主机隧道。之后该服务器会代替客户端与目的主机建立连接。连接建立好之后，代理服务器会面向客户端发送或接收 TCP 消息流。
  * 0x02表示BIND请求
  > Bind方法使用于目标主机需要主动连接客户机的情况(ftp协议)  
 
  当服务端接收到的数据包中CMD为X'02'时，服务器使用Bind方法进行代理。使用Bind方法代理时服务端需要回复客户端至多两次数据包。
   
  服务端使用TCP协议连接对应的(DST.ADDR, DST.PORT)，如果失败则返回失败状态的数据包并且关闭此次会话。如果成功，则监听(BND.ADDR, BND.PORT)来接受请求的主机的请求，然后返回第一次数据包，该数据包用以让客户机发送指定目标主机连接客户机地址和端口的数据包。    

  在目标主机连接服务端指定的地址和端口成功或失败之后，回复第二次数据包。此时的(BND.ADDR, BND.PORT)应该为目标主机与服务端建立的连接的地址和端口。
  
  * 0x03表示UDP转发
* RSV 0x00，保留
* ATYP 类型
  * 0x01 IPv4地址，DST.ADDR部分4字节长度
  * 0x03 域名，DST.ADDR部分第一个字节为域名长度，DST.ADDR剩余的内容为域名，没有\0结尾。
  * 0x04 IPv6地址，16个字节长度。
* DST.ADDR 目的地址
* DST.PORT 网络字节序表示的目的端口
示例数据
> <Buffer 05 01 00 01 0e d7 b1 26 01 bb>

>  服务器根据客户端封装数据，请求远端服务器，将下面固定格式响应给客户端。   

| VER | CMD | RSV  | ATYP | DST.ADDR | DST.PORT |
| --- | --- | ---- | ---- | -------- | -------- |
| 1   | 1   | 0x00 | 1    | 动态     | 2        |

* VER是SOCKS版本，这里应该是0x05；
* REP应答字段
  * 0x00表示成功
  * 0x01普通SOCKS服务器连接失败
  * 0x02现有规则不允许连接
  * 0x03网络不可达
  * 0x04主机不可达
  * 0x05连接被拒
  * 0x06 TTL超时
  * 0x07不支持的命令
  * 0x08不支持的地址类型
  * 0x09 - 0xFF未定义

* RSV 0x00，保留
* ATYP
  * 0x01 IPv4地址，DST.ADDR部分4字节长度
  * 0x03域名，DST.ADDR部分第一个字节为域名长度，DST.ADDR剩余的内容为域名，没有\0结尾。
  * 0x04 IPv6地址，16个字节长度。

* BND.ADDR 服务器绑定的地址
* BND.PORT 网络字节序表示的服务器绑定的端口